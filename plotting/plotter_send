#!/usr/bin/env python3

import serial, argparse
import hpgl

plotter_settings = {
    "titan" : {
        "baudrate": 38400,
        "xonxoff": True,
        "stopbits":serial.STOPBITS_ONE
    }
}

arg_parser = argparse.ArgumentParser(description="Send an HPGL file to a plotter.")
arg_parser.add_argument('--plotter', default='titan', choices=sorted(plotter_settings.keys()), type=str, help="choose plotter settings.")
arg_parser.add_argument('--dry-run', default=False, const=True, action='store_const', help="do everything except open the serial port and send the file.")
arg_parser.add_argument('port', type=str, help="The serial port the plotter is connected to.")
arg_parser.add_argument('file', type=str, help="The file of HPGL commands to send.")
args = arg_parser.parse_args()

hpgl_lines = None
with open(args.file, 'r') as f:
    hpgl_lines = f.readlines()
print(f"Read {len(hpgl_lines)} lines of HPGL.")

plot = hpgl.parse_lines(hpgl_lines)
print(plot.cuttable_repr())

chosen_plotter_settings = plotter_settings[args.plotter]

if args.dry_run:
    exit(0) # quit at this point since we were just asked for a dry run.


plotter_port = serial.Serial(port=args.port, **chosen_plotter_settings)
